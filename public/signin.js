// Generated by CoffeeScript 1.3.3
(function() {
  var Application, Member, Members, SigninView, generateUniqueTweet, members, signinView, tweet;

  Application = Thorax.Application.create();

  $(function() {
    return $('body').append(Application.el);
  });

  SigninView = Application.View.extend({
    emptyInput: true,
    events: {
      'submit': function(event) {
        return event.preventDefault();
      },
      'keyup input[type="text"]': function(event) {
        var results, val;
        val = $(event.target).val();
        if (!val || val === '') {
          this.emptyInput = true;
          results = [];
        } else {
          this.emptyInput = false;
          results = this.members.filter(function(member) {
            var name;
            name = member.attributes.member.name;
            return name.toLowerCase().search(val.toLowerCase()) !== -1;
          });
        }
        return this.filtered.reset(results);
      },
      rendered: function() {
        var target;
        target = this.$('input[type="text"]');
        return target.on('focus', function() {
          return window.scrollTo(0, target.offset().top - 5);
        });
      }
    },
    signin: function(event) {
      var member,
        _this = this;
      member = $(event.target).model();
      console.log(member);
      if (confirm("Sign in as " + member.attributes.member.name + "?")) {
        this.thankYouName = member.attributes.member.name;
        this.render();
        setTimeout(function() {
          _this.thankYouName = false;
          _this.filtered.reset([]);
          _this.emptyInput = true;
          _this.render();
          return _this.$('input[type="text"]').focus();
        }, 3000);
        $.post('/signin?memberId=' + member.attributes.member.member_id, {});
        return generateUniqueTweet(member.attributes.member.name);
      }
    },
    template: "{{#if thankYouName}}\n  <div class=\"alert alert-success\">Welcome {{thankYouName}}!</div>\n{{else}}\n  <h2>Welcome to SeattleJS <small>Please sign in</small></h2>\n  <form>\n    <input class=\"input input-large\" placeholder=\"Enter your name\" type=\"text\" autocomplete=\"off\" autocorrect=\"off\">\n  </form>\n  <table class=\"table table-striped table-bordered\">\n    {{#collection filtered tag=\"tbody\"}}\n      <tr>\n        <td><img src=\"{{member_photo.thumb_link}}\"></td>\n        <td><h3>{{member.name}}</h3></td>\n        <td>{{#button \"signin\" class=\"btn btn-primary btn\"}}Sign In{{/button}}</td>\n      </tr>\n    {{else}}\n      <tr><td>{{#if emptyInput}} {{else}}No matches{{/if}}</td></tr>\n    {{/collection}}\n  </table>\n{{/if}}"
  });

  Member = Application.Model.extend({});

  Members = Application.Collection.extend({
    model: Member,
    url: '/members.json',
    parse: function(data) {
      console.log(data);
      return data.results;
    }
  });

  members = new Members;

  signinView = SigninView.create({
    members: members,
    filtered: Application.Collection.create()
  });

  generateUniqueTweet = function(name) {
    var output, prefix, suffix, welcome;
    welcome = _.shuffle(['Salutations to', 'A warm welcome to', 'A warm but professional welcome to', 'All hail', 'Welcome', 'A mid-summer greetings to']).pop();
    prefix = _.shuffle(['Lord ', 'Sir ', 'Commander ', '']).pop();
    suffix = _.shuffle([' of House ' + _.shuffle(['Baratheon', 'Harrenhal', 'Lannister']).pop(), ' Esquire', '', '', '']).pop();
    output = "" + welcome + " " + prefix + name + suffix + " #seattlejs";
    return tweet(output);
  };

  tweet = function(tweet) {
    return $.post('/tweet?tweet=' + encodeURIComponent(tweet), {});
  };

  members.fetch({
    success: function() {
      window.members = members;
      return Application.setView(signinView, {
        destroy: false
      });
    }
  });

}).call(this);
